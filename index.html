<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#4f46e5">
  <title>Kalkulator Beban Kerja JF AKN</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Phosphor Icons -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  
  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <!-- Babel untuk kompilasi JSX di Browser -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 2px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #cbd5e1; }
  </style>
</head>
<body class="bg-slate-50 font-sans text-slate-900 overflow-hidden font-black">
  <div id="root"></div>

  <!-- Script Utama Aplikasi (React via Babel) -->
  <script type="text/babel">
    const { useState, useMemo, useEffect, useRef, useCallback } = React;

    // Prefiks untuk kunci LocalStorage agar tidak bentrok dengan aplikasi lain
    const APP_PREFIX = "akn_local_";

    // --- PENGATURAN TEMA APLIKASI (WHITE-LABEL) ---
    // Deklarasi eksplisit agar CDN Tailwind mengenali class-class ini
    const THEME_OPTIONS = {
      indigo: { bg: 'bg-indigo-600', hover: 'hover:bg-indigo-700', text: 'text-indigo-600', light: 'bg-indigo-50', border: 'border-indigo-100', hoverBorder: 'hover:border-indigo-400', ring: 'focus:ring-indigo-500' },
      blue: { bg: 'bg-blue-600', hover: 'hover:bg-blue-700', text: 'text-blue-600', light: 'bg-blue-50', border: 'border-blue-100', hoverBorder: 'hover:border-blue-400', ring: 'focus:ring-blue-500' },
      emerald: { bg: 'bg-emerald-600', hover: 'hover:bg-emerald-700', text: 'text-emerald-600', light: 'bg-emerald-50', border: 'border-emerald-100', hoverBorder: 'hover:border-emerald-400', ring: 'focus:ring-emerald-500' },
      amber: { bg: 'bg-amber-500', hover: 'hover:bg-amber-600', text: 'text-amber-600', light: 'bg-amber-50', border: 'border-amber-100', hoverBorder: 'hover:border-amber-400', ring: 'focus:ring-amber-500' },
      purple: { bg: 'bg-purple-600', hover: 'hover:bg-purple-700', text: 'text-purple-600', light: 'bg-purple-50', border: 'border-purple-100', hoverBorder: 'hover:border-purple-400', ring: 'focus:ring-purple-500' },
      rose: { bg: 'bg-rose-600', hover: 'hover:bg-rose-700', text: 'text-rose-600', light: 'bg-rose-50', border: 'border-rose-100', hoverBorder: 'hover:border-rose-400', ring: 'focus:ring-rose-500' }
    };

    // --- DATA MASTER KONSTAN ---
    const MASTER_SKPD_DATA = [
      { id: "SK.01", label: "Analisis Kinerja Historis dan Penyusunan RKA-SKPD Berbasis Bukti", uVol: "dokumen/tahun", uTime: "jam/dokumen", dVol: 1, dTime: 50, desc: "Menganalisis data kinerja dan realisasi anggaran 3 tahun terakhir guna menyusun usulan anggaran yang rasional (outcome-based budgeting)." },
      { id: "SK.02", label: "Kajian Internal Efektivitas dan Efisiensi Belanja Program Unggulan SKPD", uVol: "program/tahun", uTime: "jam/program", dVol: 2, dTime: 30, desc: "Evaluasi mendalam dengan metode cost-effectiveness analysis pada program utama unit." },
      { id: "SK.03", label: "Simulasi dan Analisis Dampak Perubahan Kebijakan terhadap Anggaran SKPD", uVol: "analisis/skenario", uTime: "jam/skenario", dVol: 3, dTime: 10, desc: "Model finansial simulasi dampak aturan baru pusat/daerah terhadap unit kerja." },
      { id: "SK.04", label: "Analisis Realisasi Anggaran Triwulanan dan Penyusunan Prognosis Prediktif", uVol: "laporan/triwulan", uTime: "jam/laporan", multiplier: 4, dVol: 1, dTime: 12, desc: "Analisis pola deviasi dan proyeksi serapan akhir tahun bagi pimpinan unit." },
      { id: "SK.05", label: "Analisis Kepatuhan Pajak atas Belanja SKPD dan Rekomendasi Mitigasi", uVol: "laporan/semester", uTime: "jam/laporan", multiplier: 2, dVol: 1, dTime: 16, desc: "Review kepatuhan pemotongan pajak belanja unit guna meminimalkan risiko temuan." },
      { id: "SK.06", label: "Analisis Akurasi Pencatatan Akrual och Koreksi Laporan Keuangan", uVol: "laporan/semester", uTime: "jam/laporan", multiplier: 2, dVol: 1, dTime: 20, desc: "Menganalisis ketepatan pengakuan aset/beban sesuai SAP guna integritas laporan keuangan." },
      { id: "SK.07", label: "Penyusunan Analisis Laporan Keuangan SKPD (Non-Mekanis)", uVol: "laporan/semester", uTime: "jam/laporan", multiplier: 2, dVol: 1, dTime: 24, desc: "Penjelasan naratif analitis atas angka laporan keuangan untuk keputusan pimpinan." },
      { id: "SK.08", label: "Review Hasil Pemeriksaan dan Mitigasi Risiko Temuan Berulang", uVol: "laporan/tahun", uTime: "jam/laporan", dVol: 1, dTime: 32, desc: "Analisis akar penyebab temuan pemeriksaan dan penyusunan sistem pencegahan." },
      { id: "SK.09", label: "Analisis Kebutuhan Belanja Modal dan Perencanaan Pengadaan BMD", uVol: "dokumen/tahun", uTime: "jam/dokumen", dVol: 1, dTime: 30, desc: "Mengkaji urgensi pengadaan aset baru berdasarkan kebutuhan layanan nyata." },
      { id: "SK.10", label: "Analisis Pemanfaatan och Utilisasi Aset di Unit Kerja", uVol: "laporan/tahun", uTime: "jam/laporan", dVol: 1, dTime: 20, desc: "Evaluasi apakah aset unit telah digunakan secara optimal mendukung tugas fungsi." },
      { id: "SK.11", label: "Review Kelayakan Usulan Penghapusan Aset Unit", uVol: "dokumen/tahun", uTime: "jam/dokumen", dVol: 1, dTime: 15, desc: "Analisis teknis dan ekonomis terhadap aset yang akan dihapuskan guna akuntabilitas." },
      { id: "SK.12", label: "Review dan Analisis Data Dukung untuk Perencanaan Strategis (Renstra) SKPD", uVol: "kali/periodisasi", uTime: "jam/periodisasi", dVol: 1, dTime: 25, desc: "Memberikan kontribusi analitis pada Renstra SKPD terkait kesinambungan fiskal." },
      { id: "SK.13", label: "Penyusunan Karya Tulis/Kajian Mini Pengelolaan Keuangan SKPD", uVol: "karya/tahun", uTime: "jam/karya", dVol: 1, dTime: 40, desc: "Menghasilkan karya ilmiah terapan (best practice) guna pengembangan ilmu pengelolaan daerah." },
      { id: "SK.14", label: "Partisipasi Forum/Workshop Pengembangan Kebijakan Keuangan Daerah", uVol: "kali/tahun", uTime: "jam/kegiatan", dVol: 2, dTime: 8, desc: "Mengikuti diskusi workshop penyempurnaan sistem keuangan daerah yang diselenggarakan BKAD." },
      { id: "SK.15", label: "Pengecekan Administratif Usulan Penghapusan Aset Unit (Pertama)", uVol: "usulan/tahun", uTime: "jam/usulan", dVol: 25, dTime: 1, desc: "Memeriksa kelengkapan dokumen aset (foto, berita acara) sebelum analisis teknis muda/madya." },
      { id: "SK.16", label: "Penyusunan Draft Laporan Kinerja Keuangan Unit (Pertama)", uVol: "laporan/triwulan", uTime: "jam/laporan", multiplier: 4, dVol: 1, dTime: 4, desc: "Mengisi template laporan kinerja dengan data realisasi awal berdasarkan sistem." },
      { id: "SK.17", label: "Penyiapan Bahan Paparan PPT & Infografis Keuangan SKPD (Pertama)", uVol: "paparan/bulan", uTime: "jam/paparan", multiplier: 12, dVol: 1, dTime: 2, desc: "Mengonversi hasil analisis keuangan menjadi slide presentasi komunikatif bagi pimpinan." },
      { id: "SK.18", label: "Pengelolaan Arsip & Database Dokumen Perencanaan SKPD (Pertama)", uVol: "dokumen/bulan", uTime: "jam/dokumen", multiplier: 12, dVol: 50, dTime: 0.5, desc: "Scanning dan pengarsipan sistematis dokumen perencanaan (Renstra, RKA) fisik dan digital." }
    ];

    const MASTER_BAPENDA_DATA = [
      { id: "BP.01", label: "Analisis dan Penyusunan Kebijakan Strategis Pajak Daerah", uVol: "dokumen kebijakan/tahun", uTime: "jam/dokumen", dVol: 2, dTime: 60, desc: "Menganalisis kinerja jenis pajak, membandingkan dengan daerah lain, dan menyusun draf kebijakan strategis." },
      { id: "BP.02", label: "Kajian Potensi dan Kelayakan Penerimaan Pajak Daerah Baru", uVol: "kajian kelayakan/tahun", uTime: "jam/kajian", dVol: 1, dTime: 80, desc: "Studi mendalam fiscal gap analysis untuk identifikasi sumber pajak daerah baru yang potensial." },
      { id: "BP.03", label: "Evaluasi Efektivitas Kebijakan Insentif Pajak", uVol: "evaluasi/tahun", uTime: "jam/ev", dVol: 1, dTime: 40, desc: "Menganalisis dampak kebijakan insentif terhadap kepatuhan wajib pajak dan PAD." },
      { id: "BP.04", label: "Analisis Pengembangan Sistem Elektronifikasi Pajak (ETPD)", uVol: "kajian sistem/tahun", uTime: "jam/kajian", dVol: 1, dTime: 50, desc: "Mengevaluasi sistem existing dan spesifikasi teknis peningkatan layanan digital." },
      { id: "BP.05", label: "Analisis Profil Risiko Kepatuhan Wajib Pajak Strategis", uVol: "laporan/bulan", uTime: "jam/lap", multiplier: 12, dVol: 1, dTime: 24, desc: "Scoring risiko WP berdasarkan tren pembayaran dan data transaksi pihak ketiga." },
      { id: "BP.06", label: "Analisis Kelayakan Administrasi Penagihan Aktif (Jurusan/Sita)", uVol: "laporan/semester", uTime: "jam/laporan", multiplier: 2, dVol: 1, dTime: 20, desc: "Review efektivitas penagihan piutang pajak melalui langkah hukum perpajakan." },
      ...MASTER_SKPD_DATA.slice(6, 18).map(s => ({...s, id: "BP." + s.id.split('.')[1]}))
    ];

    const MASTER_ANGGARAN_DATA = [
      { id: "BK.PA.01", label: "Analisis & Verifikasi RKA-SKPD (APBD & Perubahan)", uVol: "dokumen/tahun", uTime: "jam/dok", dVol: 21349, dTime: 0.33, desc: "Analisis administratif och substansi usulan anggaran SKPD seluruh kota." },
      { id: "BK.PA.02", label: "Review Laporan Realisasi Anggaran Tematik", uVol: "laporan/bulan", uTime: "jam/lap", multiplier: 12, dVol: 1, dTime: 3, desc: "Analisis tren belanja guna identifikasi deviasi dan rekomendasi korektif bulanan." },
      { id: "BK.PA.03", label: "Penyusunan Kajian Fiskal Daerah & Analisis Hubungan Keuangan Pusat-Daerah", uVol: "kajian/tahun", uTime: "jam/kajian", dVol: 2, dTime: 40, desc: "Kajian kemandirian fiskal dan dampak kebijakan transfer pusat." },
      { id: "BK.PA.04", label: "Monitoring & Evaluasi Kinerja APBD", uVol: "laporan/tri", uTime: "jam/lap", multiplier: 4, dVol: 1, dTime: 6, desc: "Eveluasi capaian outcome program se-kota dan analisis hambatan serapan anggaran." },
      { id: "BK.PA.05", label: "Koordinasi Teknis dan Fasilitasi Penyusunan Anggaran SKPD", uVol: "kali/tahun", uTime: "jam/keg", dVol: 24, dTime: 2, desc: "Memimpin rapat/diskusi teknis penyelarasan kebijakan anggaran daerah bersama SKPD." },
      { id: "BK.PA.06", label: "Pengolahan, Analisis, dan Sinkronisasi Data Anggaran", uVol: "dokumen", uTime: "jam", dVol: 100, dTime: 0.5, desc: "Integrasi data anggaran lintas sistem guna memastikan validitas angka tahapan penganggaran." },
      { id: "BK.PA.07", label: "Review Kebijakan Belanja Daerah dalam rangka Efisiensi & Efektivitas", uVol: "dokumen", uTime: "jam", dVol: 2, dTime: 40, desc: "Kajian pola belanja produktif dan rekomendasi realokasi anggaran ke sektor prioritas kota." },
      ...MASTER_SKPD_DATA.slice(14, 18).map((s, i) => ({...s, id: `BK.PA.${(i+8).toString().padStart(2, '0')}`})),
      { id: "BK.PA.20", label: "Supervisi dan Bimbingan Teknis Intensif Penganggaran SKPD Percontohan", uVol: "SKPD/tahun", uTime: "jam/SKPD", dVol: 2, dTime: 30, desc: "Memberikan pendampingan khusus dan review berlapis proses penganggaran unit sampel." }
    ];

    const MASTER_AKUNTANSI_DATA = Array.from({length: 16}, (_, i) => ({ id: `BK.AK.${(i+1).toString().padStart(2, '0')}`, label: i === 0 ? "Penyusunan Laporan Keuangan Pokok Daerah (LKPD)" : `Analisis Akuntansi Lanjutan ke-${i+1}`, uVol: "dok", uTime: "jam", dVol: 1, dTime: i === 0 ? 100 : 20, desc: "Review kepatuhan pelaporan keuangan daerah sesuai SAP." }));
    const MASTER_ASET_DATA = Array.from({length: 16}, (_, i) => ({ id: `BK.AS.${(i+1).toString().padStart(2, '0')}`, label: i === 0 ? "Penyusunan & Pemutakhiran Standar Harga Barang & Jasa" : `Manajemen Kekayaan Daerah ke-${i+1}`, uVol: "aset", uTime: "jam", dVol: 1, dTime: i === 0 ? 80 : 15, desc: "Analisis pemanfaatan dan pengamanan barang milik daerah." }));

    const MASTER_PERBENDAHARAAN_DATA = [
      { id: "BK.PB.01", label: "Analisis Dokumen Pelaksanaan APBD dan Laporan Realisasi", uVol: "dokumen/tahun", uTime: "jam/dok", dVol: 15000, dTime: 0.25, desc: "Analisis kuantitatif dan validasi dokumen SPP/SP2D/LPJ guna akurasi perencanaan anggaran." },
      { id: "BK.PB.02", label: "Analisis Arus Kas (Cash Flow) dan Proyeksi Likuiditas Harian", uVol: "laporan/minggu", uTime: "jam/lap", multiplier: 48, dVol: 1, dTime: 2, desc: "Memantau posisi kas dan membuat proyeksi jangka pendek untuk menjaga likuiditas harian kas daerah." },
      { id: "BK.PB.03", label: "Verifikasi dan Rekonsiliasi Data Kas dengan Bank/Kas Daerah", uVol: "transaksi/tahun", uTime: "jam/trans", dVol: 20000, dTime: 0.1, desc: "Pencocokan data bendahara dengan bukti bank guna menjamin akurasi nilai transaksi kas." },
      ...Array.from({length: 12}, (_, i) => ({ id: `BK.PB.${(i+4).toString().padStart(2, '0')}`, label: `Manajemen Perbendaharaan ke-${i+4}`, uVol: "lap", uTime: "jam", dVol: 1, dTime: 20, desc: "Aktivitas penatausahaan dan pengelolaan likuiditas daerah." }))
    ];

    const INITIAL_MASTER_MAP = {
      "SKPD": MASTER_SKPD_DATA,
      "BAPENDA": MASTER_BAPENDA_DATA,
      "BKAD_ANGGARAN": MASTER_ANGGARAN_DATA,
      "BKAD_AKUNTANSI": MASTER_AKUNTANSI_DATA,
      "BKAD_ASET": MASTER_ASET_DATA,
      "BKAD_PERBENDAHARAAN": MASTER_PERBENDAHARAAN_DATA
    };

    // --- DATABASE REFERENSI SKPD DEFAULT ---
    const DEFAULT_SKPD_LIST = [
      { name: "Badan Kepegawaian dan Pengembangan Sumber Daya Manusia", type: "SKPD" },
      { name: "Badan Kesatuan Bangsa dan Politik", type: "SKPD" },
      { name: "Badan Keuangan dan Aset Daerah", type: "BKAD" },
      { name: "Badan Penanggulangan Bencana Daerah", type: "SKPD" },
      { name: "Badan Pendapatan Daerah", type: "BAPENDA" },
      { name: "Badan Perencanaan Pembangunan Daerah", type: "SKPD" },
      { name: "Dinas Kependudukan dan Pencatatan Sipil", type: "SKPD" },
      { name: "Dinas Kesehatan", type: "SKPD" },
      { name: "Dinas Pendidikan", type: "SKPD" },
      { name: "Dinas Perhubungan", type: "SKPD" },
      { name: "Dinas Sosial", type: "SKPD" },
      { name: "Sekretariat Daerah", type: "SKPD" },
      { name: "Kecamatan Medan Amplas", type: "SKPD" }
    ];

    // Helper API Gemini
    const envApiKey = ""; 
    const callGemini = async (prompt, systemInstruction, userApiKey) => {
      const activeKey = userApiKey || envApiKey;
      const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${activeKey}`;
      const payload = {
        contents: [{ parts: [{ text: prompt }] }],
        systemInstruction: { parts: [{ text: systemInstruction }] }
      };
      let delay = 1000;
      for (let i = 0; i < 5; i++) {
        try {
          const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
          const result = await response.json();
          if (response.ok) return result.candidates?.[0]?.content?.parts?.[0]?.text;
          if (result.error) throw new Error(result.error.message);
        } catch (e) { if (i === 4) throw e; }
        await new Promise(resolve => setTimeout(resolve, delay));
        delay *= 2;
      }
      throw new Error("AI Timeout");
    };

    const App = () => {

      // --- PENGATURAN AI & WHITE-LABEL STATE ---
      const [customApiKey, setCustomApiKey] = useState(() => localStorage.getItem(`${APP_PREFIX}gemini_api_key`) || "");
      const [keySavedMsg, setKeySavedMsg] = useState("");

      const [customAppName, setCustomAppName] = useState(() => localStorage.getItem(`${APP_PREFIX}app_name`) || "Kalkulator JF AKN");
      const [customPemdaName, setCustomPemdaName] = useState(() => localStorage.getItem(`${APP_PREFIX}pemda_name`) || "Sistem Analisis Beban Kerja Terpadu");
      const [customLogo, setCustomLogo] = useState(() => localStorage.getItem(`${APP_PREFIX}app_logo`) || null);
      const [appTheme, setAppTheme] = useState(() => localStorage.getItem(`${APP_PREFIX}app_theme`) || "indigo");
      const [brandingSavedMsg, setBrandingSavedMsg] = useState("");

      // Helper untuk mendapatkan objek tema aktif
      const t = THEME_OPTIONS[appTheme] || THEME_OPTIONS.indigo;

      // --- LOGIN STATE ---
      const [isLoggedIn, setIsLoggedIn] = useState(() => !!localStorage.getItem(`${APP_PREFIX}user_name`));
      const [loginName, setLoginName] = useState(() => localStorage.getItem(`${APP_PREFIX}user_name`) || "");
      
      // --- MOBILE MENU STATE ---
      const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);

      // --- PWA STATE ---
      const [deferredPrompt, setDeferredPrompt] = useState(null);

      // --- STATE UTAMA ---
      const [isSyncing, setIsSyncing] = useState(false);
      const [activeTab, setActiveTab] = useState("PANDUAN"); // Set default tab to Cara Pakai
      
      // --- STATE MASTER (FROM LOCALSTORAGE) ---
      const [masterTasks, setMasterTasks] = useState(() => {
        const saved = localStorage.getItem(`${APP_PREFIX}master_tasks`);
        return saved ? JSON.parse(saved) : INITIAL_MASTER_MAP;
      });

      const [skpdList, setSkpdList] = useState(() => {
        const saved = localStorage.getItem(`${APP_PREFIX}skpd_list`);
        return saved ? JSON.parse(saved) : DEFAULT_SKPD_LIST;
      });

      const [masterTabMode, setMasterTabMode] = useState("KEGIATAN"); // KEGIATAN | SKPD
      const [newSkpdName, setNewSkpdName] = useState("");
      const [newSkpdType, setNewSkpdType] = useState("SKPD");

      const [unitKerja, setUnitKerja] = useState("Badan Keuangan dan Aset Daerah");
      const [jenisUnit, setJenisUnit] = useState("BKAD"); 
      const [activeBidang, setActiveBidang] = useState("");
      
      const [answers, setAnswers] = useState({});
      const [bezetting, setBezetting] = useState({ PERTAMA: 0, MUDA: 0, MADYA: 0 });
      const [fulfillment, setFulfillment] = useState({});
      const [monitoringList, setMonitoringList] = useState([]);
      const [searchSKPD, setSearchSKPD] = useState("");
      const [filterKuesioner, setFilterKuesioner] = useState("");
      const [searchMaster, setSearchMaster] = useState("");
      const [activeBidangMaster, setActiveBidangMaster] = useState("SKPD");
      const [showSKPDList, setShowSKPDList] = useState(false);
      const [isAiLoading, setIsAiLoading] = useState(false);
      const [aiAnalysis, setAiAnalysis] = useState(null);
      const [lastSaved, setLastSaved] = useState(null);
      const [showDeleteModal, setShowDeleteModal] = useState(null);

      const jke = 1476;
      const fileInputRef = useRef(null);
      const masterFileInputRef = useRef(null);

      // --- PWA INITIALIZATION ---
      useEffect(() => {
        const svgIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><rect width="512" height="512" rx="112" fill="#4f46e5"/><path fill="#ffffff" d="M149.333 362.667v-213.334h213.334v213.334h-213.334zM192 320h128v-128h-128v128z"/><path fill="#ffffff" d="M256 106.667c-82.347 0-149.333 66.987-149.333 149.333s66.987 149.333 149.333 149.333 149.333-66.987 149.333-149.333-66.987-149.333-149.333-149.333z m0 256c-58.88 0-106.667-47.787-106.667-106.667s47.787-106.667 106.667-106.667 106.667 47.787 106.667 106.667-47.787 106.667-106.667 106.667z"/></svg>`;
        const base64Icon = `data:image/svg+xml;base64,${btoa(svgIcon)}`;
        const manifest = {
          name: customAppName, short_name: customAppName.split(' ')[0], description: "Kalkulator Beban Kerja",
          start_url: ".", display: "standalone", background_color: "#f8fafc", theme_color: "#4f46e5",
          icons: [ { src: base64Icon, sizes: "192x192", type: "image/svg+xml" }, { src: base64Icon, sizes: "512x512", type: "image/svg+xml" } ]
        };
        const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
        const manifestUrl = URL.createObjectURL(manifestBlob);
        
        let manifestLink = document.querySelector('link[rel="manifest"]');
        if (!manifestLink) { manifestLink = document.createElement('link'); manifestLink.rel = 'manifest'; document.head.appendChild(manifestLink); }
        manifestLink.href = manifestUrl;

        if ('serviceWorker' in navigator) {
          const swCode = `self.addEventListener('install', (e) => self.skipWaiting()); self.addEventListener('activate', (e) => e.waitUntil(self.clients.claim())); self.addEventListener('fetch', (e) => { e.respondWith(fetch(e.request).catch(() => caches.match(e.request))); });`;
          const swBlob = new Blob([swCode], { type: 'application/javascript' });
          const swUrl = URL.createObjectURL(swBlob);
          navigator.serviceWorker.register(swUrl).catch(() => {});
        }

        const handler = (e) => { e.preventDefault(); setDeferredPrompt(e); };
        window.addEventListener('beforeinstallprompt', handler);
        return () => window.removeEventListener('beforeinstallprompt', handler);
      }, [customAppName]);

      const handleInstallClick = async () => {
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') setDeferredPrompt(null);
      };

      // --- UPDATE DOCUMENT TITLE DYNAMICALLY ---
      useEffect(() => {
        document.title = customAppName;
      }, [customAppName]);

      // --- LOCAL STORAGE DATA SYNC ---
      
      // Load data saat unitKerja berubah
      useEffect(() => {
        const docId = unitKerja.replace(/\s+/g, '_');
        const savedData = localStorage.getItem(`${APP_PREFIX}skpd_data_${docId}`);
        if (savedData) {
          const d = JSON.parse(savedData);
          setAnswers(d.answers || {});
          setBezetting(d.bezetting || { PERTAMA: 0, MUDA: 0, MADYA: 0 });
          setFulfillment(d.fulfillment || {});
          setLastSaved(d.timestamp || new Date().toLocaleTimeString());
        } else {
          setAnswers({}); setBezetting({ PERTAMA: 0, MUDA: 0, MADYA: 0 }); setFulfillment({}); setLastSaved(null);
        }
      }, [unitKerja]);

      // Auto Save fungsi penyimpanan
      const autoSave = useCallback((updates) => {
        setIsSyncing(true);
        const docId = unitKerja.replace(/\s+/g, '_');
        const key = `${APP_PREFIX}skpd_data_${docId}`;
        
        const existingDataStr = localStorage.getItem(key);
        const existingData = existingDataStr ? JSON.parse(existingDataStr) : {};
        
        const timestamp = new Date().toLocaleTimeString();
        const newData = { ...existingData, ...updates, unitKerja, timestamp };
        
        localStorage.setItem(key, JSON.stringify(newData));
        setLastSaved(timestamp);
        
        // Animasi UI sync sebentar
        setTimeout(() => setIsSyncing(false), 500);
      }, [unitKerja]);

      const fetchMonitoringData = useCallback(() => {
        const list = skpdList.map(skpdObj => {
          const savedStr = localStorage.getItem(`${APP_PREFIX}skpd_data_${skpdObj.name.replace(/\s+/g, '_')}`);
          const data = savedStr ? JSON.parse(savedStr) : null;
          
          return {
            nama: skpdObj.name,
            filled: !!data,
            abk: data?.summary?.abk || "0.000",
            lastUpdate: data?.timestamp || "-"
          };
        });
        setMonitoringList(list);
      }, [skpdList]);

      useEffect(() => { if (activeTab === "MONITORING") fetchMonitoringData(); }, [activeTab, fetchMonitoringData]);

      // PROFIL DATA MAPPER
      const profilesDataMap = useMemo(() => ({
        "BKAD": {
          [`ANGGARAN (${masterTasks.BKAD_ANGGARAN?.length || 0})`]: masterTasks.BKAD_ANGGARAN,
          [`AKUNTANSI (${masterTasks.BKAD_AKUNTANSI?.length || 0})`]: masterTasks.BKAD_AKUNTANSI,
          [`ASET (${masterTasks.BKAD_ASET?.length || 0})`]: masterTasks.BKAD_ASET,
          [`PERBENDAHARAAN (${masterTasks.BKAD_PERBENDAHARAAN?.length || 0})`]: masterTasks.BKAD_PERBENDAHARAAN,
          [`SEKRETARIAT (${masterTasks.SKPD?.length || 0})`]: masterTasks.SKPD
        },
        "BAPENDA": {
          [`PENDAPATAN DAERAH (${masterTasks.BAPENDA?.length || 0})`]: masterTasks.BAPENDA,
          [`SEKRETARIAT (${masterTasks.SKPD?.length || 0})`]: masterTasks.SKPD
        },
        "SKPD": {
          [`SEKRETARIAT SKPD (${masterTasks.SKPD?.length || 0})`]: masterTasks.SKPD
        }
      }), [masterTasks]);

      useEffect(() => {
        const keys = Object.keys(profilesDataMap[jenisUnit]);
        if (!keys.includes(activeBidang)) setActiveBidang(keys[0] || "");
      }, [jenisUnit, profilesDataMap, activeBidang]);

      const resultsData = useMemo(() => {
        let list = []; let totalJam = 0; let bPerJenjang = { PERTAMA: 0, MUDA: 0, MADYA: 0 };
        const currentTasks = profilesDataMap[jenisUnit];
        if(!currentTasks) return { list: [], totalJam: 0, formasi: { PERTAMA: "0.000", MUDA: "0.000", MADYA: "0.000", TOTAL: "0.000" } };

        Object.values(currentTasks).forEach(taskList => {
          taskList?.forEach(task => {
            const v = answers[`${task.id}_vol`] || 0;
            const n = answers[`${task.id}_time`] || 0;
            const m = task.multiplier || 1;
            const jam = v * m * n;
            if (jam > 0) {
              const txt = (task.label + " " + (task.desc || "")).toLowerCase();
              const j = (txt.includes("strategis") || txt.includes("kebijakan")) ? "MADYA" : (txt.includes("analisis") || txt.includes("review")) ? "MUDA" : "PERTAMA";
              bPerJenjang[j] += jam;
              list.push({ ...task, jam, realVol: v * m, realNW: n, jenjang: j });
              totalJam += jam;
            }
          });
        });
        return { list, totalJam, formasi: {
          PERTAMA: (bPerJenjang.PERTAMA / jke).toFixed(3),
          MUDA: (bPerJenjang.MUDA / jke).toFixed(3),
          MADYA: (bPerJenjang.MADYA / jke).toFixed(3),
          TOTAL: (totalJam / jke).toFixed(3)
        }};
      }, [answers, jenisUnit, profilesDataMap]);

      const handleValChange = (taskId, field, val) => {
        const numericVal = val === '' ? 0 : Number(val);
        const newAnswers = { ...answers, [`${taskId}_${field}`]: numericVal };
        setAnswers(newAnswers);
        autoSave({ answers: newAnswers, summary: { abk: resultsData.formasi.TOTAL } });
      };

      const saveMasterTasksLocal = (newMaster) => {
        setMasterTasks(newMaster);
        localStorage.setItem(`${APP_PREFIX}master_tasks`, JSON.stringify(newMaster));
      };

      const handleUpdateMaster = (category, index, field, value) => {
        const newMaster = { ...masterTasks };
        newMaster[category][index][field] = value;
        saveMasterTasksLocal(newMaster);
      };

      const handleAddNewTaskMaster = () => {
        const prefixMap = { "SKPD": "SK", "BAPENDA": "BP", "BKAD_ANGGARAN": "BK.PA", "BKAD_AKUNTANSI": "BK.AK", "BKAD_ASET": "BK.AS", "BKAD_PERBENDAHARAAN": "BK.PB" };
        const prefix = prefixMap[activeBidangMaster] || "XX";
        const newId = `${prefix}.${(masterTasks[activeBidangMaster].length + 1).toString().padStart(2, '0')}`;
        const newTask = { id: newId, label: "Butir Kegiatan Baru", uVol: "dokumen", uTime: "jam", dVol: 1, dTime: 20, desc: "Deskripsi tugas baru" };
        
        const newMaster = { ...masterTasks };
        newMaster[activeBidangMaster] = [...newMaster[activeBidangMaster], newTask];
        saveMasterTasksLocal(newMaster);
      };

      const handleDeleteMaster = (category, index) => {
        const newMaster = { ...masterTasks };
        newMaster[category].splice(index, 1);
        saveMasterTasksLocal(newMaster);
      };

      // FUNGSI EXPORT & IMPORT MASTER DATA
      const handleDownloadMasterTemplate = () => {
        const rows = [["Kategori", "ID", "Aktivitas", "Satuan Volume", "Satuan Waktu", "Norma Waktu", "Deskripsi"]];
        Object.keys(masterTasks).forEach(cat => {
          masterTasks[cat].forEach(t => {
            rows.push([cat, t.id, t.label, t.uVol || "", t.uTime || "", t.dTime || 0, t.desc || ""]);
          });
        });
        const csvContent = rows.map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(";")).join("\r\n");
        const blob = new Blob(["\ufeff" + csvContent], { type: 'text/csv;charset=utf-8;' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Template_Master_Kegiatan.csv`; a.click();
      };

      const handleImportMasterCSV = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (evt) => {
          const text = evt.target.result;
          const lines = text.split(/\r?\n/);
          const newMaster = { ...masterTasks };
          let importedCount = 0;

          lines.forEach((line, index) => {
            if (index === 0 || !line.trim()) return; // Lewati header atau baris kosong
            const delimiter = line.includes(';') ? ';' : ',';
            const p = line.split(new RegExp(`${delimiter}(?=(?:(?:[^"]*"){2})*[^"]*$)`)).map(x => x.replace(/^"|"$/g, "").trim());
            
            // Format: Kategori | ID | Aktivitas | uVol | uTime | dTime | desc
            if (p.length >= 6 && p[0] && p[1]) {
              const cat = p[0];
              const id = p[1];
              const label = p[2] || "Tanpa Judul";
              const uVol = p[3] || "dokumen";
              const uTime = p[4] || "jam";
              const dTime = parseFloat(p[5]) || 0;
              const desc = p[6] || "";

              if (!newMaster[cat]) newMaster[cat] = []; // Buat kategori baru jika belum ada

              const existingIdx = newMaster[cat].findIndex(t => t.id === id);
              const newTask = { id, label, uVol, uTime, dTime, desc, dVol: 1 };

              if (existingIdx >= 0) {
                newMaster[cat][existingIdx] = { ...newMaster[cat][existingIdx], ...newTask };
              } else {
                newMaster[cat].push(newTask);
              }
              importedCount++;
            }
          });

          saveMasterTasksLocal(newMaster);
          alert(`Berhasil mengimpor/memperbarui ${importedCount} butir kegiatan master.`);
          e.target.value = null; // Reset input
        };
        reader.readAsText(file);
      };

      const handleDeleteSKPD = () => {
        if (!showDeleteModal) return;
        const docId = showDeleteModal.replace(/\s+/g, '_');
        
        // Hapus dari local storage
        localStorage.removeItem(`${APP_PREFIX}skpd_data_${docId}`);
        fetchMonitoringData();
        setShowDeleteModal(null);
        
        // Reset state jika yang dihapus adalah yang sedang dibuka
        if(unitKerja === showDeleteModal) {
            setAnswers({}); setBezetting({ PERTAMA: 0, MUDA: 0, MADYA: 0 }); setFulfillment({}); setLastSaved(null);
        }
      };

      const handleDownloadTemplate = () => {
        const rows = [["ID", "Kegiatan", "Volume (Masukan)", "Norma (Masukan)"]];
        Object.keys(profilesDataMap[jenisUnit]).forEach(bidang => {
          rows.push(["", `--- ${bidang} ---`, "", ""]);
          profilesDataMap[jenisUnit][bidang].forEach(t => rows.push([t.id, t.label, "", ""]));
        });
        // Menggunakan titik koma (;) sebagai delimiter pemisah kolom standar Excel Indonesia
        const csvContent = rows.map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(";")).join("\r\n");
        const blob = new Blob(["\ufeff" + csvContent], { type: 'text/csv;charset=utf-8;' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Template_ABK_${jenisUnit}.csv`; a.click();
      };

      const handleImportCSV = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (evt) => {
          const text = evt.target.result;
          const lines = text.split(/\r?\n/);
          const newAnswers = { ...answers };
          let duplicatesCount = 0;
          lines.forEach(line => {
            if (line.startsWith('sep=') || line.startsWith('"ID"')) return;
            const delimiter = line.includes(';') ? ';' : ',';
            const p = line.split(new RegExp(`${delimiter}(?=(?:(?:[^"]*"){2})*[^"]*$)`)).map(x => x.replace(/^"|"$/g, "").trim());
            if (p.length >= 3 && p[0] !== "") {
              const id = p[0];
              if (newAnswers[`${id}_vol`] !== undefined) duplicatesCount++;
              if (!isNaN(parseFloat(p[2]))) newAnswers[`${id}_vol`] = parseFloat(p[2]);
              if (!isNaN(parseFloat(p[3]))) newAnswers[`${id}_time`] = parseFloat(p[3]);
            }
          });
          setAnswers(newAnswers);
          autoSave({ answers: newAnswers });
          if (duplicatesCount > 0) alert(`Peringatan: Terdapat ${duplicatesCount} data yang diperbarui.`);
          else alert("Impor berhasil.");
        };
        reader.readAsText(file);
      };

      const handleExport = () => {
        const rows = [["LAPORAN ANALISIS BEBAN KERJA", "", "", "", "", ""], [`UNIT: ${unitKerja}`, "", "", "", "", ""], ["", "", "", "", "", ""], ["ID", "Aktivitas", "Volume", "Norma", "Total Jam", "Jenjang"]];
        resultsData.list.forEach(r => rows.push([r.id, r.label, r.realVol, r.realNW, r.jam, r.jenjang]));
        // Menggunakan titik koma (;) sebagai delimiter pemisah kolom standar Excel Indonesia
        const csvContent = rows.map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(";")).join("\r\n");
        const blob = new Blob(["\ufeff" + csvContent], { type: 'text/csv;charset=utf-8;' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `ABK_${unitKerja}.csv`; a.click();
      };

      // FUNGSI MANAJEMEN SKPD CUSTOM LOKAL
      const handleSaveSkpdList = (newList) => {
        setSkpdList(newList);
        localStorage.setItem(`${APP_PREFIX}skpd_list`, JSON.stringify(newList));
      };

      const handleAddSkpd = () => {
        if (!newSkpdName.trim()) return;
        const isExist = skpdList.find(s => s.name.toLowerCase() === newSkpdName.trim().toLowerCase());
        if (isExist) {
          alert("Nama Unit Kerja/SKPD ini sudah ada di dalam referensi!");
          return;
        }
        const newList = [...skpdList, { name: newSkpdName.trim(), type: newSkpdType }];
        handleSaveSkpdList(newList);
        setNewSkpdName("");
        setNewSkpdType("SKPD");
      };

      const handleDeleteSkpdReference = (index) => {
        if (skpdList.length <= 1) {
          alert("Harus ada minimal 1 SKPD di dalam database!");
          return;
        }
        const confirmDelete = window.confirm("Hapus SKPD ini dari referensi? (Data kuesioner yang sudah diisi untuk SKPD ini tidak akan terhapus, namun tidak akan muncul di monitoring).");
        if (confirmDelete) {
          const newList = [...skpdList];
          newList.splice(index, 1);
          handleSaveSkpdList(newList);
        }
      };

      const handleSKPDChangeConfirm = (nama) => {
        setUnitKerja(nama); setShowSKPDList(false);
        const targetSkpd = skpdList.find(s => s.name === nama);
        if (targetSkpd) {
          setJenisUnit(targetSkpd.type);
        } else {
          setJenisUnit("SKPD");
        }
      };

      const handleAIAnalysis = async () => {
        if (resultsData.totalJam === 0) return;
        
        if (!customApiKey.trim()) {
          setAiAnalysis("API Key belum dikonfigurasi. Silakan masukkan Gemini API Key Anda di menu PENGATURAN AI terlebih dahulu.");
          setActiveTab("PENGATURAN");
          return;
        }

        setIsAiLoading(true); setAiAnalysis(null);
        const prompt = `Unit: ${unitKerja}, ABK: ${resultsData.formasi.TOTAL}. Rekomendasi strategis pengisian sesuai PMK 78/2025.`;
        try {
          const insight = await callGemini(prompt, "Pakar SDM Pemda", customApiKey);
          setAiAnalysis(insight);
        } catch (e) { 
          setAiAnalysis(`Gagal memproses analisis AI. Pastikan API Key valid.\n\nError Detail: ${e.message}`); 
        }
        setIsAiLoading(false);
      };

      const handleLoginSubmit = (e) => {
        e.preventDefault();
        if (loginName.trim() !== "") {
          localStorage.setItem(`${APP_PREFIX}user_name`, loginName);
          setIsLoggedIn(true);
        }
      };

      const handleLogout = () => {
        localStorage.removeItem(`${APP_PREFIX}user_name`);
        setIsLoggedIn(false);
        setLoginName("");
      };

      const handleLogoUpload = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        if(file.size > 1500000) {
           alert("Ukuran file logo terlalu besar. Maksimal 1.5MB");
           return;
        }
        const reader = new FileReader();
        reader.onload = (evt) => {
          setCustomLogo(evt.target.result);
        };
        reader.readAsDataURL(file);
      };

      const saveBranding = () => {
        localStorage.setItem(`${APP_PREFIX}app_name`, customAppName);
        localStorage.setItem(`${APP_PREFIX}pemda_name`, customPemdaName);
        localStorage.setItem(`${APP_PREFIX}app_theme`, appTheme);
        if(customLogo) {
          localStorage.setItem(`${APP_PREFIX}app_logo`, customLogo);
        } else {
          localStorage.removeItem(`${APP_PREFIX}app_logo`);
        }
        setBrandingSavedMsg("Kustomisasi berhasil disimpan!");
        setTimeout(() => setBrandingSavedMsg(""), 3000);
      };

      // Tampilan Login (Jika belum login)
      if (!isLoggedIn) {
        return (
          <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-100 to-slate-200 p-4 w-full">
            <div className="bg-white p-10 rounded-[2.5rem] shadow-xl w-full max-w-md border border-slate-100 animate-in fade-in zoom-in-95 duration-300">
              <div className="flex justify-center mb-6">
                 <div className={`p-4 rounded-3xl text-white shadow-lg flex items-center justify-center w-24 h-24 overflow-hidden ${t.bg}`}>
                   {customLogo ? (
                     <img src={customLogo} alt="App Logo" className="w-full h-full object-contain bg-white rounded-xl" />
                   ) : (
                     <i className="ph-fill ph-calculator text-[48px]"></i>
                   )}
                 </div>
              </div>
              <h2 className="text-2xl font-black text-slate-800 text-center mb-2 italic uppercase">{customAppName}</h2>
              <p className="text-xs font-bold text-slate-400 text-center mb-10 uppercase tracking-widest">{customPemdaName}</p>
              
              <form onSubmit={handleLoginSubmit} className="space-y-6">
                <div>
                  <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 block">Nama Pengguna / NIP</label>
                  <div className="relative">
                    <i className="ph-fill ph-user absolute left-4 top-3.5 text-[18px] text-slate-400"></i>
                    <input 
                      type="text" 
                      required
                      value={loginName}
                      onChange={(e) => setLoginName(e.target.value)}
                      placeholder="Masukkan nama anda..." 
                      className={`w-full bg-slate-50 border border-slate-200 rounded-xl pl-12 pr-4 py-3 text-sm font-bold outline-none focus:ring-2 transition-all ${t.ring}`}
                    />
                  </div>
                </div>
                <button type="submit" className={`w-full flex justify-center items-center gap-2 text-white font-black py-4 rounded-xl text-xs uppercase tracking-widest shadow-lg active:scale-95 transition-all ${t.bg} ${t.hover}`}>
                  Masuk Aplikasi <i className="ph-bold ph-arrow-right text-[14px]"></i>
                </button>
              </form>
              
              <div className="mt-8 text-center border-t border-slate-100 pt-6">
                 <p className="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-1">Data Tersimpan Aman di Perangkat Anda</p>
                 <p className="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Didukung oleh Cloud AI</p>
              </div>
            </div>
          </div>
        );
      }

      // Tampilan Aplikasi Utama (Setelah Login)
      return (
        <div className="h-screen flex overflow-hidden w-full animate-in fade-in">
          
          {/* Mobile Overlay */}
          {isMobileMenuOpen && (
            <div className="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-40 lg:hidden" onClick={() => setIsMobileMenuOpen(false)}></div>
          )}

          {/* Sidebar */}
          <aside className={`fixed left-0 top-0 h-full w-72 bg-white border-r border-slate-200 p-6 flex flex-col shadow-2xl lg:shadow-sm z-50 overflow-y-auto custom-scrollbar text-slate-700 transition-transform duration-300 ease-in-out ${isMobileMenuOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'}`}>
            <div className="flex items-center justify-between gap-3 mb-10 shrink-0">
              <div className="flex items-center gap-3 w-full overflow-hidden">
                <div className={`p-2 rounded-xl text-white shadow-lg shrink-0 flex items-center justify-center w-10 h-10 overflow-hidden ${t.bg}`}>
                   {customLogo ? (
                     <img src={customLogo} alt="Logo" className="w-full h-full object-contain bg-white rounded-lg" />
                   ) : (
                     <i className="ph-fill ph-calculator text-[20px]"></i>
                   )}
                </div>
                <h1 className="font-black text-lg tracking-tight leading-none uppercase italic text-slate-800 truncate" title={customAppName}>
                  {customAppName.split(' ')[0]} <span className={t.text}>{customAppName.split(' ').slice(1).join(' ')}</span>
                </h1>
              </div>
              <button onClick={() => setIsMobileMenuOpen(false)} className="lg:hidden p-2 text-slate-400 hover:bg-slate-100 rounded-xl transition-colors shrink-0">
                <i className="ph-bold ph-x text-[20px]"></i>
              </button>
            </div>

            <nav className="space-y-6 flex-1">
              <div className="space-y-1">
                {[
                  { id: "PANDUAN", label: "CARA PAKAI", icon: "ph-book-open" },
                  { id: "MONITORING", label: "MONITORING", icon: "ph-squares-four" },
                  { id: "KUESIONER", label: "KUESIONER", icon: "ph-clipboard-text" },
                  { id: "PROYEKSI", label: "RENCANA FORMASI", icon: "ph-target" },
                  { id: "LAPORAN", label: "LAPORAN ABK", icon: "ph-file-text" },
                  { id: "MASTER", label: "REFERENSI DATA", icon: "ph-database" },
                  { id: "PENGATURAN", label: "PENGATURAN AI", icon: "ph-gear" }
                ].map(tab => (
                  <button key={tab.id} onClick={() => { setActiveTab(tab.id); setIsMobileMenuOpen(false); }}
                    className={`w-full text-left px-4 py-3 rounded-xl text-xs font-bold transition-all flex items-center gap-3 ${activeTab === tab.id ? `${t.light} ${t.text} shadow-sm border ${t.border}` : 'text-slate-400 hover:bg-slate-50 border border-transparent'}`}
                  >
                    <i className={`ph-fill ${tab.icon} text-[16px]`}></i>
                    {tab.label}
                  </button>
                ))}
              </div>

              {activeTab === "KUESIONER" && (
                <div className="pt-6 border-t border-slate-100 animate-in fade-in shrink-0">
                  <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4 italic text-center text-slate-400">Daftar Bidang {jenisUnit}</p>
                  <div className="space-y-1">
                    {Object.keys(profilesDataMap[jenisUnit]).map(b => (
                      <button key={b} onClick={() => { setActiveBidang(b); setIsMobileMenuOpen(false); }}
                        className={`w-full text-left px-4 py-2.5 rounded-lg font-black tracking-wide transition-all border text-[9px] leading-tight ${activeBidang === b ? `${t.bg} text-white ${t.border} shadow-md` : 'text-slate-400 hover:bg-slate-50 border-transparent'}`}
                      >
                        {b}
                      </button>
                    ))}
                  </div>
                </div>
              )}
            </nav>

            <div className="pt-6 border-t border-slate-100 space-y-2 shrink-0">
              <div className={`${t.light} p-3 rounded-xl border ${t.border} mb-2 shadow-inner font-black`}>
                 <div className="flex items-center justify-between mb-1">
                    <span className={`text-[8px] uppercase ${t.text}`}>Halo, {loginName}</span>
                    {isSyncing ? <i className={`ph-bold ph-arrows-clockwise text-[10px] animate-spin ${t.text}`}></i> : <i className={`ph-fill ph-device-mobile text-[10px] ${t.text}`}></i>}
                 </div>
                 <p className={`text-[9px] font-bold truncate ${t.text}`}>{lastSaved ? `Lokal: ${lastSaved}` : 'Menyimpan...'}</p>
              </div>
              {deferredPrompt && (
                 <button onClick={handleInstallClick} className={`w-full flex items-center justify-center gap-2 px-4 py-3 text-white rounded-xl text-[10px] hover:shadow-lg transition-all shadow-md animate-pulse mb-2 ${t.bg} ${t.hover}`}>
                    <i className="ph-fill ph-device-mobile text-[14px]"></i> INSTALL APLIKASI
                 </button>
              )}
              <button onClick={() => fileInputRef.current.click()} className={`w-full flex items-center gap-3 px-4 py-3 text-white rounded-xl text-[10px] shadow-md transition-all ${t.bg} ${t.hover}`}>
                <i className="ph-bold ph-upload-simple text-[14px]"></i> IMPORT CSV
              </button>
              <button onClick={handleDownloadTemplate} className="w-full flex items-center gap-3 px-4 py-2 bg-white text-slate-500 rounded-xl text-[10px] hover:bg-slate-50 border border-slate-200 shadow-sm transition-all">
                <i className="ph-bold ph-download text-[14px]"></i> UNDUH TEMPLATE
              </button>
              <button onClick={handleLogout} className="w-full flex items-center gap-3 px-4 py-2 bg-rose-50 text-rose-500 rounded-xl text-[10px] hover:bg-rose-100 border border-rose-100 shadow-sm transition-all mt-2">
                <i className="ph-bold ph-sign-out text-[14px]"></i> KELUAR
              </button>
              <input type="file" ref={fileInputRef} onChange={handleImportCSV} className="hidden" accept=".csv" />
              <input type="file" ref={masterFileInputRef} onChange={handleImportMasterCSV} className="hidden" accept=".csv" />
            </div>
          </aside>

          <main className="lg:ml-72 p-4 md:p-6 lg:p-10 pb-32 w-full h-screen min-w-0 overflow-y-auto">
            <div className="max-w-6xl mx-auto">
              {/* Header */}
              <div className="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4 lg:gap-6 mb-8 lg:mb-10">
                <div className="flex items-center gap-3 w-full lg:w-2/3">
                  <button onClick={() => setIsMobileMenuOpen(true)} className={`lg:hidden p-3 md:p-4 bg-white border border-slate-200 rounded-2xl shadow-sm hover:bg-slate-50 transition-all flex-shrink-0 ${t.text}`}>
                    <i className="ph-bold ph-list text-[20px] md:text-[24px]"></i>
                  </button>
                  <div className="relative w-full">
                    <p className="text-[10px] text-slate-400 uppercase tracking-widest mb-2 items-center gap-2 hidden md:flex">
                      <i className="ph-bold ph-magnifying-glass text-[12px]"></i> Unit Kerja Aktif:
                    </p>
                    <div onClick={() => setShowSKPDList(!showSKPDList)} className={`bg-white border border-slate-200 p-3 md:p-4 rounded-2xl shadow-sm cursor-pointer flex justify-between items-center transition-all ${t.hoverBorder}`}>
                      <span className="text-slate-800 text-sm md:text-lg truncate">{unitKerja}</span>
                      <i className={`ph-bold ph-caret-down text-[16px] md:text-[20px] text-slate-400 transition-transform ${showSKPDList ? 'rotate-180' : ''}`}></i>
                    </div>
                    {showSKPDList && (
                      <div className="absolute top-full left-0 w-full bg-white mt-2 rounded-2xl md:rounded-3xl shadow-2xl border border-slate-100 z-50 overflow-hidden animate-in fade-in">
                        <div className="p-3 md:p-4 border-b bg-slate-50">
                          <input autoFocus placeholder="Cari..." className={`w-full bg-white border border-slate-200 rounded-xl px-4 py-2 text-sm outline-none focus:ring-2 transition-all ${t.ring}`} value={searchSKPD} onChange={(e) => setSearchSKPD(e.target.value)} />
                        </div>
                        <div className="max-h-60 md:max-h-80 overflow-y-auto custom-scrollbar">
                          {skpdList.filter(s=>s.name.toLowerCase().includes(searchSKPD.toLowerCase())).map((skpdObj) => (
                            <div key={skpdObj.name} onClick={() => handleSKPDChangeConfirm(skpdObj.name)} className={`px-4 md:px-6 py-3 md:py-4 text-xs font-bold hover:bg-slate-50 cursor-pointer border-b last:border-none flex justify-between items-center ${unitKerja === skpdObj.name ? `${t.text} ${t.light}` : ''}`}>
                              <span className="truncate pr-4">{skpdObj.name}</span>
                              <span className={`px-2 py-0.5 rounded-[4px] text-[8px] uppercase shrink-0 ${skpdObj.type === 'BKAD' ? 'bg-emerald-100 text-emerald-700' : skpdObj.type === 'BAPENDA' ? 'bg-amber-100 text-amber-700' : 'bg-slate-200 text-slate-500'}`}>{skpdObj.type}</span>
                            </div>
                          ))}
                          {skpdList.filter(s=>s.name.toLowerCase().includes(searchSKPD.toLowerCase())).length === 0 && (
                             <div className="px-6 py-8 text-center text-xs text-slate-400 italic">Tidak ditemukan. Coba tambah di menu Referensi Data.</div>
                          )}
                        </div>
                      </div>
                    )}
                  </div>
                </div>
                
                <div className="flex flex-col sm:flex-row gap-3 w-full lg:w-auto mt-2 lg:mt-0 items-end">
                  {deferredPrompt && (
                    <button onClick={handleInstallClick} className={`w-full sm:w-auto text-white px-6 py-3 md:py-4 lg:py-3 rounded-2xl text-xs shadow-xl flex items-center justify-center gap-2 transition-all h-fit self-end animate-pulse ${t.bg} ${t.hover}`}>
                      <i className="ph-fill ph-device-mobile text-[16px]"></i> INSTALL PWA
                    </button>
                  )}
                  <button onClick={handleAIAnalysis} disabled={isAiLoading} className={`w-full sm:w-auto text-white px-8 py-3 md:py-4 lg:py-3 rounded-2xl text-xs shadow-xl flex items-center justify-center gap-2 transition-all h-fit self-end ${t.bg} ${t.hover}`}>
                     {isAiLoading ? <i className="ph-bold ph-spinner text-[16px] animate-spin"></i> : <i className="ph-fill ph-sparkle text-[16px]"></i>} ANALISIS AI
                  </button>
                </div>
              </div>

              {/* Delete Modal */}
              {showDeleteModal && (
                <div className="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
                   <div className="bg-white rounded-[2rem] p-8 max-w-sm w-full shadow-2xl border border-slate-100">
                      <div className="bg-rose-100 text-rose-600 w-12 h-12 rounded-2xl flex items-center justify-center mb-6"><i className="ph-fill ph-trash text-[24px]"></i></div>
                      <h3 className="text-xl text-slate-800 mb-2 leading-tight text-center">Hapus data {showDeleteModal}?</h3>
                      <p className="text-sm text-slate-500 font-medium mb-8 leading-relaxed text-center">Seluruh jawaban kuesioner unit ini akan dihapus dari perangkat Anda.</p>
                      <div className="flex gap-3">
                         <button onClick={() => setShowDeleteModal(null)} className="flex-1 px-4 py-3 rounded-xl bg-slate-100 text-slate-600 text-xs font-bold">BATAL</button>
                         <button onClick={handleDeleteSKPD} className="flex-1 px-4 py-3 rounded-xl bg-rose-600 text-white text-xs font-bold shadow-lg shadow-rose-100">HAPUS</button>
                      </div>
                   </div>
                </div>
              )}

              {/* AI Analysis Modal */}
              {aiAnalysis && (
                <div className="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4 animate-in fade-in">
                   <div className="bg-white rounded-[2rem] p-8 max-w-2xl w-full shadow-2xl border border-slate-100 max-h-[85vh] flex flex-col">
                      <div className="flex justify-between items-center mb-6 shrink-0">
                        <div className="flex items-center gap-3">
                          <div className={`${t.light} ${t.text} w-12 h-12 rounded-2xl flex items-center justify-center`}><i className="ph-fill ph-sparkle text-[24px]"></i></div>
                          <div>
                            <h3 className="text-xl text-slate-800 leading-tight font-black">Rekomendasi AI</h3>
                            <p className="text-[10px] text-slate-400 uppercase tracking-widest">{unitKerja}</p>
                          </div>
                        </div>
                        <button onClick={() => setAiAnalysis(null)} className="p-2 text-slate-400 hover:bg-slate-100 rounded-xl transition-colors"><i className="ph-bold ph-x text-[20px]"></i></button>
                      </div>
                      
                      <div className="overflow-y-auto custom-scrollbar flex-1 pr-4">
                        <div className="text-sm text-slate-600 leading-relaxed font-medium whitespace-pre-wrap bg-slate-50 p-6 rounded-2xl border border-slate-100">
                          {aiAnalysis}
                        </div>
                      </div>
                      
                      <div className="mt-6 pt-4 border-t border-slate-100 flex justify-end shrink-0">
                        <button onClick={() => setAiAnalysis(null)} className={`px-6 py-3 rounded-xl text-white text-xs font-bold transition-colors shadow-lg ${t.bg} ${t.hover}`}>TUTUP ANALISIS</button>
                      </div>
                   </div>
                </div>
              )}

              {/* KONTEN PANDUAN (CARA PAKAI) */}
              {activeTab === "PANDUAN" && (
                <div className="bg-white rounded-[2rem] md:rounded-[2.5rem] p-6 md:p-10 border border-slate-200 shadow-sm animate-in fade-in">
                  <h3 className="text-xl md:text-2xl text-slate-800 uppercase tracking-tighter flex items-center gap-3 mb-6 md:mb-10 leading-none">
                    <i className={`ph-fill ph-book-open text-[20px] md:text-[24px] ${t.text}`}></i> Panduan Penggunaan
                  </h3>

                  <div className="space-y-6 md:space-y-8 max-w-4xl">
                    <div className="flex flex-col md:flex-row gap-4 md:gap-6 items-start">
                      <div className={`w-12 h-12 rounded-2xl flex items-center justify-center shrink-0 font-black text-xl text-white shadow-md ${t.bg}`}>1</div>
                      <div className={`flex-1 ${t.light} p-6 rounded-3xl border ${t.border} shadow-inner`}>
                        <h4 className={`text-lg font-black mb-2 flex items-center gap-2 ${t.text}`}>
                          <i className="ph-fill ph-gear"></i> Pengaturan Sistem & Branding
                        </h4>
                        <p className="text-sm text-slate-600 leading-relaxed font-medium">Langkah pertama sebelum menggunakan aplikasi adalah masuk ke menu <strong>PENGATURAN AI</strong> (menu paling bawah). Di sana Anda dapat mengunggah logo instansi Anda, mengubah nama aplikasi, memilih tema warna, dan yang paling penting: <strong>Memasukkan API Key Gemini</strong> agar fitur Analisis AI dapat berfungsi maksimal.</p>
                      </div>
                    </div>

                    <div className="flex flex-col md:flex-row gap-4 md:gap-6 items-start">
                      <div className={`w-12 h-12 rounded-2xl flex items-center justify-center shrink-0 font-black text-xl text-white shadow-md ${t.bg}`}>2</div>
                      <div className={`flex-1 ${t.light} p-6 rounded-3xl border ${t.border} shadow-inner`}>
                        <h4 className={`text-lg font-black mb-2 flex items-center gap-2 ${t.text}`}>
                          <i className="ph-fill ph-database"></i> Kelola Referensi Data Master
                        </h4>
                        <p className="text-sm text-slate-600 leading-relaxed font-medium">Buka menu <strong>REFERENSI DATA</strong>. Pastikan Anda menyesuaikan <strong>Daftar Nama SKPD</strong> sesuai dengan instansi di Pemerintah Daerah Anda (Pilih klasifikasi yang tepat: SKPD Umum, BKAD, atau BAPENDA). Anda juga dapat mengunduh format CSV, mengedit via Excel, lalu mengimpornya kembali untuk memperbarui <strong>Master Butir Kegiatan</strong>.</p>
                      </div>
                    </div>

                    <div className="flex flex-col md:flex-row gap-4 md:gap-6 items-start">
                      <div className={`w-12 h-12 rounded-2xl flex items-center justify-center shrink-0 font-black text-xl text-white shadow-md ${t.bg}`}>3</div>
                      <div className={`flex-1 ${t.light} p-6 rounded-3xl border ${t.border} shadow-inner`}>
                        <h4 className={`text-lg font-black mb-2 flex items-center gap-2 ${t.text}`}>
                          <i className="ph-fill ph-clipboard-text"></i> Pengisian Kuesioner
                        </h4>
                        <p className="text-sm text-slate-600 leading-relaxed font-medium">Klik bagian <strong>Unit Kerja Aktif</strong> (di bagian atas layar) untuk memilih SKPD yang ingin Anda evaluasi. Setelah itu, buka menu <strong>KUESIONER</strong> dan isikan <strong>Volume</strong> serta <strong>Norma Waktu</strong> pada setiap butir kegiatan yang dilakukan unit tersebut. Sistem akan menyimpan hasil kerja Anda secara otomatis.</p>
                      </div>
                    </div>

                    <div className="flex flex-col md:flex-row gap-4 md:gap-6 items-start">
                      <div className={`w-12 h-12 rounded-2xl flex items-center justify-center shrink-0 font-black text-xl text-white shadow-md ${t.bg}`}>4</div>
                      <div className={`flex-1 ${t.light} p-6 rounded-3xl border ${t.border} shadow-inner`}>
                        <h4 className={`text-lg font-black mb-2 flex items-center gap-2 ${t.text}`}>
                          <i className="ph-fill ph-chart-bar"></i> Pantau, Proyeksi & Laporan
                        </h4>
                        <p className="text-sm text-slate-600 leading-relaxed font-medium">Pantau rekapitulasi progres seluruh SKPD di menu <strong>MONITORING</strong>. Anda dapat melihat proyeksi kebutuhan SDM 5 tahun ke depan melalui menu <strong>RENCANA FORMASI</strong>. Unduh laporan final dalam format Excel (CSV) di menu <strong>LAPORAN ABK</strong>. Jangan lupa gunakan tombol <strong>ANALISIS AI</strong> di pojok kanan atas untuk mendapatkan ringkasan cerdas berbasis AI!</p>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {activeTab === "MONITORING" && (
                <div className="bg-white rounded-[2rem] md:rounded-[2.5rem] p-6 md:p-10 border border-slate-200 shadow-sm animate-in fade-in">
                  <h3 className="text-xl md:text-2xl text-slate-800 uppercase tracking-tighter flex items-center gap-3 mb-6 md:mb-10 leading-none">
                    <i className={`ph-fill ph-squares-four text-[20px] md:text-[24px] ${t.text}`}></i> Monitoring Progres Pengisian
                  </h3>
                  <div className="overflow-x-auto rounded-2xl md:rounded-3xl border border-slate-100 shadow-inner">
                    <table className="w-full text-left border-collapse">
                      <thead>
                        <tr className="bg-slate-50 text-[10px] text-slate-400 uppercase tracking-widest border-b">
                          <th className="px-6 py-5">Nama SKPD</th>
                          <th className="px-4 py-5 text-center">Status</th>
                          <th className="px-4 py-5 text-center">ABK</th>
                          <th className="px-4 py-5 text-center">Aksi</th>
                          <th className="px-6 py-5 text-right">Update</th>
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-slate-100 text-xs font-bold text-slate-700">
                        {monitoringList.map((m, i) => (
                          <tr key={i} className="hover:bg-slate-50 transition-colors group">
                            <td className="px-6 py-6 truncate max-w-[400px]">{m.nama}</td>
                            <td className="px-4 py-6 text-center">
                              {m.filled ? 
                                <span className="bg-emerald-100 text-emerald-700 px-3 py-1 rounded-full text-[9px] uppercase flex items-center justify-center gap-1 w-fit mx-auto leading-none"><i className="ph-fill ph-check-circle text-[10px]"></i> Terisi</span> : 
                                <span className="bg-slate-100 text-slate-400 px-3 py-1 rounded-full text-[9px] uppercase flex items-center justify-center gap-1 w-fit mx-auto leading-none"><i className="ph-bold ph-circle-dashed text-[10px]"></i> Belum</span>
                              }
                            </td>
                            <td className={`px-4 py-6 text-center ${t.text}`}>{m.abk}</td>
                            <td className="px-4 py-6 text-center">
                               {m.filled && (
                                 <button onClick={() => setShowDeleteModal(m.nama)} className="p-2 text-rose-400 hover:bg-rose-50 rounded-lg transition-all opacity-0 group-hover:opacity-100"><i className="ph-bold ph-trash text-[16px]"></i></button>
                               )}
                            </td>
                            <td className="px-6 py-6 text-right text-[9px] text-slate-400 italic">{m.lastUpdate}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}

              {activeTab === "MASTER" && (
                <div className="bg-white rounded-[2rem] md:rounded-[2.5rem] p-6 md:p-10 border border-slate-200 shadow-sm animate-in fade-in">
                  <div className="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6 md:mb-8 border-b pb-6 gap-4">
                    <div>
                      <h3 className="text-xl md:text-2xl text-slate-800 uppercase tracking-tighter flex items-center gap-3">
                        <i className={`ph-fill ph-database text-[20px] md:text-[24px] ${t.text}`}></i> Referensi Data Master
                      </h3>
                      <p className="text-[10px] md:text-xs text-slate-400 mt-1 uppercase tracking-widest italic leading-none">Pusat Manajemen Basis Data Aplikasi</p>
                    </div>
                  </div>

                  {/* SUB-MENU TAB UNTUK MASTER */}
                  <div className="flex gap-2 md:gap-4 mb-8 bg-slate-50 p-1.5 rounded-2xl w-fit">
                    <button onClick={() => setMasterTabMode('KEGIATAN')} className={`px-4 md:px-6 py-2.5 text-xs font-black rounded-xl transition-all ${masterTabMode === 'KEGIATAN' ? `bg-white ${t.text} shadow-sm` : 'text-slate-400 hover:text-slate-600'}`}>
                       Master Butir Kegiatan
                    </button>
                    <button onClick={() => setMasterTabMode('SKPD')} className={`px-4 md:px-6 py-2.5 text-xs font-black rounded-xl transition-all ${masterTabMode === 'SKPD' ? `bg-white ${t.text} shadow-sm` : 'text-slate-400 hover:text-slate-600'}`}>
                       Daftar Nama SKPD (Pemda)
                    </button>
                  </div>
                  
                  {/* KONTEN: MASTER KEGIATAN */}
                  {masterTabMode === "KEGIATAN" && (
                    <div className="animate-in fade-in slide-in-from-bottom-2">
                      <div className="flex flex-wrap gap-2 w-full mb-8">
                         <select className={`flex-1 lg:flex-none bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-xs outline-none focus:ring-2 transition-all ${t.ring}`} value={activeBidangMaster} onChange={(e) => setActiveBidangMaster(e.target.value)}>
                            {Object.keys(masterTasks).map(cat => <option key={cat} value={cat}>{cat.replace('_', ' ')}</option>)}
                         </select>
                         <div className="relative flex-1 lg:w-auto">
                            <input placeholder="Cari di master..." className={`w-full bg-slate-50 border border-slate-200 rounded-xl px-10 py-3 text-xs outline-none focus:ring-2 transition-all ${t.ring}`} value={searchMaster} onChange={(e) => setSearchMaster(e.target.value)} />
                            <i className="ph-bold ph-magnifying-glass text-[14px] absolute left-4 top-3.5 text-slate-400"></i>
                         </div>
                         
                         <div className="flex gap-2 w-full sm:w-auto mt-2 sm:mt-0 ml-auto">
                           <button onClick={handleDownloadMasterTemplate} title="Unduh Format / Backup Data Master" className="flex-1 sm:flex-none bg-white border border-slate-200 text-slate-600 p-3 rounded-xl hover:bg-slate-50 shadow-sm transition-all flex items-center justify-center">
                             <i className="ph-bold ph-download-simple text-[20px]"></i>
                           </button>
                           <button onClick={() => masterFileInputRef.current.click()} title="Import / Timpa Data Master via CSV" className="flex-1 sm:flex-none bg-white border border-slate-200 text-emerald-600 p-3 rounded-xl hover:bg-emerald-50 shadow-sm transition-all flex items-center justify-center">
                             <i className="ph-bold ph-upload-simple text-[20px]"></i>
                           </button>
                           <button onClick={handleAddNewTaskMaster} title="Tambah Manual" className={`flex-1 sm:flex-none text-white p-3 rounded-xl shadow-lg transition-all flex items-center justify-center ${t.bg} ${t.hover}`}>
                             <i className="ph-bold ph-plus text-[20px]"></i>
                           </button>
                         </div>
                      </div>
                      
                      <div className="space-y-6 md:space-y-12">
                         {masterTasks[activeBidangMaster]?.filter(item => item.label.toLowerCase().includes(searchMaster.toLowerCase()) || item.id.toLowerCase().includes(searchMaster.toLowerCase())).map((item, idx) => (
                            <div key={item.id} className="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-slate-200 flex flex-col md:flex-row gap-4 md:gap-6">
                               <div className="w-20 shrink-0 font-mono text-[10px] bg-slate-100 flex items-center justify-center rounded-xl h-10">{item.id}</div>
                               <div className="flex-1 space-y-4">
                                  <input className={`w-full text-xs p-3 bg-slate-50 rounded-xl outline-none focus:ring-2 transition-all ${t.ring}`} value={item.label} onChange={(e) => handleUpdateMaster(activeBidangMaster, idx, 'label', e.target.value)} />
                                  <textarea className={`w-full text-[10px] p-3 bg-slate-50 rounded-xl outline-none h-20 focus:ring-2 transition-all ${t.ring}`} value={item.desc} onChange={(e) => handleUpdateMaster(activeBidangMaster, idx, 'desc', e.target.value)} />
                               </div>
                               <div className="w-full md:w-32 shrink-0 space-y-2">
                                  <div className="text-[8px] uppercase text-slate-400 text-center hidden md:block">Norma Jam</div>
                                  <input type="number" className={`w-full text-center p-3 rounded-xl text-lg md:h-14 outline-none focus:ring-2 transition-all ${t.light} ${t.text} ${t.ring}`} placeholder="Norma" value={item.dTime} onChange={(e) => handleUpdateMaster(activeBidangMaster, idx, 'dTime', Number(e.target.value))} />
                                  <button onClick={() => handleDeleteMaster(activeBidangMaster, idx)} className="w-full p-2 text-rose-400 hover:bg-rose-50 rounded-lg transition-all flex items-center justify-center gap-1 text-[9px]">
                                    <i className="ph-bold ph-trash text-[12px]"></i> HAPUS
                                  </button>
                               </div>
                            </div>
                         ))}
                         {masterTasks[activeBidangMaster]?.filter(item => item.label.toLowerCase().includes(searchMaster.toLowerCase()) || item.id.toLowerCase().includes(searchMaster.toLowerCase())).length === 0 && (
                           <div className="py-20 text-center text-slate-300 italic">Tidak ada data master yang cocok</div>
                         )}
                      </div>
                    </div>
                  )}

                  {/* KONTEN: DAFTAR NAMA SKPD */}
                  {masterTabMode === "SKPD" && (
                    <div className="animate-in fade-in slide-in-from-bottom-2 space-y-8">
                       <div className="bg-slate-50 p-6 rounded-3xl border border-slate-100 flex flex-col md:flex-row gap-4 items-end shadow-inner">
                          <div className="flex-1 w-full space-y-2">
                             <label className="text-[10px] font-black uppercase text-slate-400 tracking-widest pl-1">Nama Organisasi (SKPD/Unit)</label>
                             <input value={newSkpdName} onChange={e => setNewSkpdName(e.target.value)} placeholder="Misal: Badan Pengelola Keuangan..." className={`w-full bg-white border border-slate-200 rounded-xl px-4 py-3 text-sm font-bold outline-none focus:ring-2 shadow-sm transition-all ${t.ring}`} />
                          </div>
                          <div className="w-full md:w-64 space-y-2">
                             <label className="text-[10px] font-black uppercase text-slate-400 tracking-widest pl-1">Klasifikasi Sistem</label>
                             <select value={newSkpdType} onChange={e => setNewSkpdType(e.target.value)} className={`w-full bg-white border border-slate-200 rounded-xl px-4 py-3 text-sm font-bold outline-none focus:ring-2 shadow-sm transition-all ${t.ring}`}>
                               <option value="SKPD">SKPD Umum</option>
                               <option value="BKAD">Pengelola Keuangan (BKAD)</option>
                               <option value="BAPENDA">Pengelola Pendapatan (BAPENDA)</option>
                             </select>
                          </div>
                          <button onClick={handleAddSkpd} className={`w-full md:w-auto text-white px-6 py-3.5 rounded-xl text-xs font-black shadow-lg transition-all flex items-center justify-center gap-2 ${t.bg} ${t.hover}`}>
                             <i className="ph-bold ph-plus text-[16px]"></i> TAMBAH
                          </button>
                       </div>

                       <div className="overflow-x-auto rounded-3xl border border-slate-200 shadow-sm">
                         <table className="w-full text-left border-collapse text-xs">
                           <thead className="bg-slate-100 text-[10px] font-black text-slate-500 uppercase tracking-widest border-b border-slate-200">
                             <tr><th className="px-6 py-5">Nama SKPD Terdaftar</th><th className="px-6 py-5">Kategori / Templat Kuesioner</th><th className="px-6 py-5 text-right">Aksi</th></tr>
                           </thead>
                           <tbody className="divide-y divide-slate-100 font-bold text-slate-700">
                             {skpdList.map((s, idx) => (
                                <tr key={idx} className="hover:bg-slate-50 transition-colors">
                                  <td className="px-6 py-5 text-sm">{s.name}</td>
                                  <td className="px-6 py-5">
                                     <span className={`px-3 py-1.5 rounded-lg text-[9px] uppercase tracking-wider font-black inline-flex items-center gap-1.5 ${s.type === 'BKAD' ? 'bg-emerald-100 text-emerald-700' : s.type === 'BAPENDA' ? 'bg-amber-100 text-amber-700' : 'bg-slate-200 text-slate-600'}`}>
                                       <i className={`ph-fill ${s.type === 'BKAD' ? 'ph-vault' : s.type === 'BAPENDA' ? 'ph-coins' : 'ph-buildings'} text-[12px]`}></i>
                                       {s.type === 'SKPD' ? 'SKPD UMUM' : s.type}
                                     </span>
                                  </td>
                                  <td className="px-6 py-5 text-right">
                                    <button onClick={() => handleDeleteSkpdReference(idx)} className="text-rose-400 hover:bg-rose-100 bg-rose-50 p-2 rounded-xl transition-all shadow-sm">
                                      <i className="ph-bold ph-trash text-[16px]"></i>
                                    </button>
                                  </td>
                                </tr>
                             ))}
                           </tbody>
                         </table>
                       </div>
                    </div>
                  )}

                </div>
              )}

              {activeTab === "KUESIONER" && (
                <div className="bg-white rounded-[2rem] md:rounded-[2.5rem] p-6 md:p-10 border border-slate-200 shadow-sm min-h-[600px] animate-in fade-in">
                  <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 md:mb-10 border-b pb-6 gap-4">
                    <div>
                      <h3 className="text-xl md:text-2xl text-slate-800 uppercase tracking-tighter italic leading-none">{activeBidang}</h3>
                      <div className={`inline-block text-white px-4 py-2 rounded-xl text-[10px] uppercase shadow-lg mt-3 md:mt-2 ${t.bg}`}>JKE: {jke} h/Thn</div>
                    </div>
                    <div className="relative w-full md:w-64">
                       <input placeholder="Cari butir kegiatan..." className={`w-full bg-slate-50 border border-slate-200 rounded-xl px-10 py-3 text-xs outline-none focus:ring-2 transition-all ${t.ring}`} value={filterKuesioner} onChange={(e) => setFilterKuesioner(e.target.value)} />
                       <i className="ph-bold ph-magnifying-glass text-[14px] absolute left-4 top-3.5 text-slate-400"></i>
                       {filterKuesioner && <i className="ph-bold ph-x text-[14px] absolute right-4 top-3.5 text-slate-400 cursor-pointer" onClick={() => setFilterKuesioner("")}></i>}
                    </div>
                  </div>

                  <div className="space-y-16 pl-4">
                    {profilesDataMap[jenisUnit][activeBidang]?.filter(task => task.label.toLowerCase().includes(filterKuesioner.toLowerCase()) || task.id.toLowerCase().includes(filterKuesioner.toLowerCase())).map((task) => (
                      <div key={task.id} className="group border-b border-slate-50 pb-12 last:border-0">
                        <h4 className={`text-[11px] text-slate-700 uppercase tracking-widest flex items-center mb-8 transition-colors ${t.text}`}>
                          <span className="text-slate-400 mr-4 text-[9px] font-mono bg-slate-50 px-2 py-0.5 rounded border">ID:{task.id}</span> {task.label}
                        </h4>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-10">
                          <div className={`${t.light} p-6 rounded-3xl border ${t.border} shadow-inner relative h-fit transition-colors`}>
                            <i className={`ph-fill ph-lightbulb text-[16px] absolute -top-2 -left-2 bg-white p-0.5 rounded-full border shadow-sm ${t.text} ${t.border}`}></i>
                            <p className={`text-[10px] uppercase tracking-widest mb-2 italic tracking-wider leading-none ${t.text}`}>Aktivitas Analitis & Kebijakan:</p>
                            <p className="text-xs text-slate-600 leading-relaxed italic font-medium">{task.desc}</p>
                          </div>
                          <div className="grid grid-cols-1 sm:grid-cols-2 gap-6 shrink-0">
                            <div className="space-y-3">
                              <label className="text-[9px] text-slate-400 uppercase tracking-widest flex items-center gap-2">
                                <i className="ph-fill ph-clipboard-text text-[12px]"></i> Volume ({task.uVol})
                              </label>
                              <input type="number" value={answers[`${task.id}_vol`] || ''} onChange={(e) => handleValChange(task.id, 'vol', e.target.value)} className={`w-full bg-slate-50 p-4 rounded-2xl border border-slate-100 text-right text-2xl focus:ring-2 shadow-inner h-14 transition-all ${t.ring}`} placeholder={task.dVol.toString()} />
                            </div>
                            <div className="space-y-3">
                              <label className="text-[9px] text-slate-400 uppercase tracking-widest flex items-center gap-2">
                                <i className="ph-fill ph-clock text-[12px]"></i> Norma ({task.uTime})
                              </label>
                              <input type="number" step="0.1" value={answers[`${task.id}_time`] || ''} onChange={(e) => handleValChange(task.id, 'time', e.target.value)} className={`w-full bg-slate-50 p-4 rounded-2xl border border-slate-100 text-right text-2xl focus:ring-2 shadow-inner h-14 transition-all ${t.ring}`} placeholder={task.dTime.toString()} />
                            </div>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {activeTab === "PROYEKSI" && (
                <div className="bg-white rounded-[2rem] md:rounded-[2.5rem] p-6 md:p-10 border border-slate-200 shadow-xl overflow-hidden animate-in fade-in">
                  <h3 className="text-xl md:text-2xl text-slate-800 uppercase tracking-tighter mb-6 md:mb-10 flex items-center gap-3 leading-none">
                    <i className={`ph-fill ph-calendar text-[20px] md:text-[24px] ${t.text}`}></i> Rencana Pemenuhan 5 Tahun
                  </h3>
                  <div className="overflow-x-auto">
                    <table className="w-full text-left border-collapse min-w-[1000px]">
                      <thead>
                        <tr className="bg-slate-50 text-[10px] text-slate-400 uppercase tracking-widest border-b">
                          <th className="px-6 py-5">Jenjang Jabatan</th>
                          <th className={`px-4 py-5 text-center ${t.light} ${t.text}`}>ABK (Kebutuhan)</th>
                          <th className="px-4 py-5 text-center">Bezetting</th>
                          <th className="px-4 py-5 text-center bg-rose-50 text-rose-700">Gap (+/-)</th>
                          {["2026", "2027", "2028"].map(y => <th key={y} className="px-4 py-5 text-center text-emerald-600">{y}</th>)}
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-slate-100 text-xs font-bold text-slate-700">
                        {["PERTAMA", "MUDA", "MADYA"].map((j) => {
                           const abk = Number(resultsData.formasi[j]);
                           const bez = bezetting[j] || 0;
                           const gap = Math.round(abk) - bez;
                           return (
                            <tr key={j} className="hover:bg-slate-50/80 transition-all">
                              <td className="px-6 py-6 italic leading-none text-slate-700">Analis Keuangan Ahli {j}</td>
                              <td className={`px-4 py-6 text-center leading-none ${t.text} ${t.light}`}>{resultsData.formasi[j]}</td>
                              <td className="px-4 py-6">
                                <input type="number" value={bez} onChange={(e) => {
                                 const nBez = {...bezetting, [j]: Number(e.target.value)};
                                 setBezetting(nBez);
                                 autoSave({ bezetting: nBez });
                                }} className={`w-16 mx-auto block bg-slate-50 border rounded-lg text-center py-1 focus:ring-2 outline-none h-10 leading-none ${t.ring}`} />
                              </td>
                              <td className={`px-4 py-6 text-center ${gap > 0 ? 'text-rose-500' : 'text-emerald-600'}`}>{gap > 0 ? `Kurang ${gap}` : gap < 0 ? `Lebih ${Math.abs(gap)}` : 'Sesuai'}</td>
                              {[1,2,3].map(yr => (
                                <td key={yr} className="px-4 py-6 bg-emerald-50/10">
                                  <input type="number" value={fulfillment[`${j}_T${yr}`] || ''} onChange={(e) => {
                                     const nFul = {...fulfillment, [`${j}_T${yr}`]: Number(e.target.value)};
                                     setFulfillment(nFul);
                                     autoSave({ fulfillment: nFul });
                                  }} className="w-14 mx-auto block bg-white border border-emerald-100 rounded-lg text-center py-1 outline-none h-10 leading-none" placeholder="0" />
                                </td>
                              ))}
                            </tr>
                          );
                        })}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}

              {activeTab === "LAPORAN" && (
                <div className="bg-white rounded-[2rem] md:rounded-[2.5rem] p-6 md:p-10 border border-slate-200 shadow-sm overflow-hidden min-h-[600px] animate-in fade-in">
                  <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6 md:mb-8 border-b pb-6 shrink-0">
                     <h3 className="text-lg md:text-xl text-slate-800 uppercase tracking-tighter italic leading-none">Laporan Analisis Beban Kerja {unitKerja}</h3>
                     <button onClick={handleExport} className={`w-full sm:w-auto justify-center text-white px-5 py-3 md:py-2 rounded-xl text-[10px] uppercase flex items-center gap-2 shadow-lg active:scale-95 leading-none md:h-10 transition-all ${t.bg} ${t.hover}`}>
                       <i className="ph-bold ph-download text-[14px]"></i> EXPORT DATA CSV
                     </button>
                  </div>
                  <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 md:gap-6 mb-8 md:mb-10">
                    {["PERTAMA", "MUDA", "MADYA"].map(j => (
                      <div key={j} className={`${t.light} p-6 rounded-3xl border ${t.border} shadow-inner group hover:opacity-80 transition-all duration-300 text-center`}>
                        <p className={`text-[10px] uppercase mb-1 leading-none tracking-widest text-center ${t.text}`}>{j}</p>
                        <p className={`text-3xl italic leading-none text-center ${t.text}`}>{resultsData.formasi[j]}</p>
                      </div>
                    ))}
                  </div>
                  <table className="w-full text-left text-[10px] border-collapse">
                    <thead className="bg-slate-50 text-slate-400 border-b uppercase">
                      <tr><th className="px-4 py-3">Rincian Aktivitas Analitis</th><th className="px-2 py-3 text-center">Beban Jam</th><th className={`px-2 py-3 text-center ${t.text}`}>Kebutuhan JF</th></tr>
                    </thead>
                    <tbody className="divide-y divide-slate-100 text-[9px] text-slate-700">
                      {resultsData.list.map(r => (
                        <tr key={r.id} className="hover:bg-slate-50/50 transition-colors">
                          <td className="px-4 py-3 leading-snug italic">{r.label}</td>
                          <td className="px-2 py-3 text-center leading-none">{Math.round(r.jam).toLocaleString()} h</td>
                          <td className={`px-2 py-3 text-center leading-none ${t.text}`}>{(r.jam/jke).toFixed(3)}</td>
                        </tr>
                      ))}
                    </tbody>
                    <tfoot className="bg-slate-900 text-white">
                      <tr><td className="px-4 py-5 uppercase italic text-xs tracking-widest leading-none">Total Kebutuhan Formasi Unit</td><td></td><td className="px-2 py-5 text-center text-sm italic leading-none">{resultsData.formasi.TOTAL}</td></tr>
                    </tfoot>
                  </table>
                </div>
              )}

              {activeTab === "PENGATURAN" && (
                <div className="bg-white rounded-[2rem] md:rounded-[2.5rem] p-6 md:p-10 border border-slate-200 shadow-sm animate-in fade-in">
                  <h3 className="text-xl md:text-2xl text-slate-800 uppercase tracking-tighter flex items-center gap-3 mb-6 md:mb-10 leading-none">
                    <i className={`ph-fill ph-gear text-[20px] md:text-[24px] ${t.text}`}></i> Pengaturan Sistem
                  </h3>

                  <div className="max-w-2xl bg-slate-50 p-6 md:p-8 rounded-3xl border border-slate-200 shadow-inner">
                    <div className="flex flex-col sm:flex-row sm:items-center gap-4 mb-6">
                      <div className={`${t.light} ${t.text} w-12 h-12 rounded-2xl flex items-center justify-center shrink-0`}>
                        <i className="ph-fill ph-key text-[24px]"></i>
                      </div>
                      <div>
                        <h4 className="text-lg font-black text-slate-800 leading-tight">Gemini API Key</h4>
                        <p className="text-xs text-slate-500 font-medium mt-1">Masukkan kunci API Anda untuk mengaktifkan fitur Analisis AI.</p>
                      </div>
                    </div>

                    <div className="space-y-4">
                      <input
                        type="password"
                        value={customApiKey}
                        onChange={(e) => setCustomApiKey(e.target.value)}
                        placeholder="AIzaSy..."
                        className={`w-full bg-white border border-slate-200 rounded-xl px-4 py-4 text-sm font-bold outline-none focus:ring-2 transition-all shadow-sm ${t.ring}`}
                      />
                      <div className="flex flex-col sm:flex-row items-center gap-3">
                        <button
                          onClick={() => {
                            localStorage.setItem(`${APP_PREFIX}gemini_api_key`, customApiKey);
                            setKeySavedMsg("API Key berhasil disimpan di perangkat Anda!");
                            setTimeout(() => setKeySavedMsg(""), 3000);
                          }}
                          className={`w-full sm:w-auto text-white px-6 py-3 rounded-xl text-xs shadow-lg flex items-center justify-center gap-2 transition-all font-black ${t.bg} ${t.hover}`}
                        >
                          <i className="ph-bold ph-floppy-disk text-[16px]"></i> SIMPAN API KEY
                        </button>
                        {keySavedMsg && (
                          <span className="text-emerald-600 text-xs font-bold flex items-center gap-1 animate-in fade-in">
                            <i className="ph-fill ph-check-circle"></i> {keySavedMsg}
                          </span>
                        )}
                      </div>
                    </div>

                    <div className="mt-6 pt-6 border-t border-slate-200">
                      <p className="text-[10px] text-slate-500 leading-relaxed font-bold">
                        <i className={`ph-fill ph-info text-[12px] mr-1 ${t.text}`}></i>
                        KEAMANAN: API Key Anda disimpan secara lokal (<span className="italic">Local Storage</span>) di *browser* perangkat Anda dan <strong>tidak dikirim</strong> ke server pusat aplikasi ini.
                      </p>
                      <p className="text-[10px] text-slate-500 mt-2 font-bold">
                        Belum punya API Key? Dapatkan secara gratis di <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noreferrer" className="underline text-slate-700">Google AI Studio</a>.
                      </p>
                    </div>
                  </div>

                  {/* WIDGET LOGO & WARNA (WHITE-LABEL) */}
                  <div className="max-w-2xl bg-slate-50 p-6 md:p-8 rounded-3xl border border-slate-200 shadow-inner mt-8">
                    <div className="flex flex-col sm:flex-row sm:items-center gap-4 mb-6">
                      <div className={`${t.light} ${t.text} w-12 h-12 rounded-2xl flex items-center justify-center shrink-0`}>
                        <i className="ph-fill ph-palette text-[24px]"></i>
                      </div>
                      <div>
                        <h4 className="text-lg font-black text-slate-800 leading-tight">Kustomisasi Tampilan (White-label)</h4>
                        <p className="text-xs text-slate-500 font-medium mt-1">Sesuaikan nama aplikasi, logo instansi, dan warna tombol.</p>
                      </div>
                    </div>

                    <div className="space-y-6">
                      <div className="flex flex-col md:flex-row gap-6">
                        <div className="flex-1">
                          <label className="text-[10px] font-black uppercase text-slate-400 tracking-widest pl-1 mb-2 block">Upload Logo Aplikasi</label>
                          <div className="flex items-center gap-4">
                              <div className={`w-16 h-16 rounded-2xl flex items-center justify-center shadow-sm overflow-hidden text-white shrink-0 ${t.bg}`}>
                                {customLogo ? <img src={customLogo} className="w-full h-full object-contain bg-white" alt="Custom Logo" /> : <i className="ph-fill ph-calculator text-[28px]"></i>}
                              </div>
                              <div className="flex-1 flex flex-col gap-2">
                                <input type="file" accept="image/png, image/jpeg" onChange={handleLogoUpload} className="text-[10px] file:mr-2 file:py-1.5 file:px-3 file:rounded-lg file:border-0 file:text-[10px] file:font-black file:bg-slate-200 file:text-slate-700 hover:file:bg-slate-300 w-full" />
                                {customLogo && <button onClick={() => setCustomLogo(null)} className="text-[10px] text-rose-500 font-bold text-left hover:underline">Hapus Logo (Reset)</button>}
                              </div>
                          </div>
                        </div>

                        <div className="flex-1">
                          <label className="text-[10px] font-black uppercase text-slate-400 tracking-widest pl-1 mb-2 block">Tema Warna Aplikasi</label>
                          <div className="flex flex-wrap gap-2 mt-2">
                              {Object.keys(THEME_OPTIONS).map(colorKey => (
                                <button 
                                  key={colorKey}
                                  onClick={() => setAppTheme(colorKey)}
                                  title={`Tema ${colorKey}`}
                                  className={`w-9 h-9 rounded-full flex items-center justify-center transition-all ${THEME_OPTIONS[colorKey].bg} ${appTheme === colorKey ? 'ring-4 ring-offset-2 ring-slate-200 scale-110' : 'hover:scale-110 opacity-80 hover:opacity-100'}`}
                                >
                                  {appTheme === colorKey && <i className="ph-bold ph-check text-white text-[14px]"></i>}
                                </button>
                              ))}
                          </div>
                        </div>
                      </div>

                      <div>
                        <label className="text-[10px] font-black uppercase text-slate-400 tracking-widest pl-1 mb-2 block">Nama Aplikasi</label>
                        <input
                          type="text"
                          value={customAppName}
                          onChange={(e) => setCustomAppName(e.target.value)}
                          placeholder="Contoh: Kalkulator JF AKN"
                          className={`w-full bg-white border border-slate-200 rounded-xl px-4 py-3.5 text-sm font-bold outline-none focus:ring-2 transition-all shadow-sm ${t.ring}`}
                        />
                      </div>
                      <div>
                        <label className="text-[10px] font-black uppercase text-slate-400 tracking-widest pl-1 mb-2 block">Nama Instansi / Pemda (Subjudul)</label>
                        <input
                          type="text"
                          value={customPemdaName}
                          onChange={(e) => setCustomPemdaName(e.target.value)}
                          placeholder="Contoh: Pemerintah Kota Medan"
                          className={`w-full bg-white border border-slate-200 rounded-xl px-4 py-3.5 text-sm font-bold outline-none focus:ring-2 transition-all shadow-sm ${t.ring}`}
                        />
                      </div>
                      
                      <div className="flex flex-col sm:flex-row items-center gap-3 pt-2">
                        <button
                          onClick={saveBranding}
                          className={`w-full sm:w-auto text-white px-6 py-3 rounded-xl text-xs shadow-lg flex items-center justify-center gap-2 transition-all font-black ${t.bg} ${t.hover}`}
                        >
                          <i className="ph-bold ph-floppy-disk text-[16px]"></i> SIMPAN PENGATURAN
                        </button>
                        {brandingSavedMsg && (
                          <span className="text-emerald-600 text-xs font-bold flex items-center gap-1 animate-in fade-in">
                            <i className="ph-fill ph-check-circle"></i> {brandingSavedMsg}
                          </span>
                        )}
                      </div>
                    </div>
                  </div>

                </div>
              )}
            </div>
          </main>

        </div>
      );
    };

    // Render React ke DOM
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>